<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ Mua H√†ng</title>
    
    <link rel="stylesheet" href="../../assets/icon/fontawesome-free-7.1.0-web/css/all.min.css"> 
    <link rel="stylesheet" href="../../assets/css/user.css">
    <link rel="stylesheet" href="../../assets/css/history.css">
</head>
<body>

    <header class="site-header">
        <div class="header-inner">
            <div class="header-left">
                <div class="logo">
                    <a href="../../index.html" aria-label="Trang ch·ªß Pocky Doll">
                        <img
                            src="../../assets/img/logo.svg" 
                            alt="Pocky Doll Logo" 
                            width="120" 
                            height="auto"
                        />
                    </a>
                </div>
            </div>
            
            <div class="header-right">
                <a href="../../index.html" class="icon-with-label" aria-label="Trang ch·ªß">
                    <div class="icon-wrap"><i class="fa-solid fa-house"></i></div>
                    <div class="icon-label">Trang ch·ªß</div>
                </a>
                
                <a href="cart.html" class="icon-with-label" aria-label="Gi·ªè h√†ng">
                    <div class="icon-wrap"><i class="fa-solid fa-cart-shopping"></i></div>
                    <div class="icon-label">Gi·ªè h√†ng</div>
                </a>
                
                <a href="history.html" class="icon-with-label history-item" title="Xem L·ªãch S·ª≠ Mua H√†ng">
                    <div class="icon-wrap"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <span class="icon-label">L·ªãch S·ª≠</span> 
                </a>

                <a href="profile.html" class="icon-with-label" aria-label="T√†i kho·∫£n">
                    <div class="icon-wrap"><i class="fa-solid fa-user"></i></div>
                    <div class="icon-label">T√†i kho·∫£n</div>
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <h1><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch S·ª≠ Mua H√†ng</h1>

        <div id="order-history-container" class="order-history-list">
        </div>

        <div id="no-history-message">
            <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</p>
            <a href="../../index.html" style="color: var(--primary);">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>
    </div>

    <script>
        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá VND
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        });

        // H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ LOCAL STORAGE (ƒê∆∞·ª£c gi·ªØ nguy√™n)
        function loadOrderHistory() {
            const historyString = localStorage.getItem('orderHistory');
            try {
                return historyString ? JSON.parse(historyString) : [];
            } catch (e) {
                console.error("L·ªói khi ƒë·ªçc l·ªãch s·ª≠ ƒë∆°n h√†ng:", e);
                return [];
            }
        }

        // H√ÄM X·ª¨ L√ù TR·∫†NG TH√ÅI (ƒê∆∞·ª£c gi·ªØ nguy√™n)
        function getStatusClass(status) {
            switch (status) {
                case 'completed': return 'status-completed';
                case 'pending': return 'status-pending';
                case 'cancelled': return 'status-cancelled';
                default: return '';
            }
        }
        function getStatusText(status) {
            switch (status) {
                case 'completed': return 'ƒê√£ Giao Th√†nh C√¥ng';
                case 'pending': return 'ƒêang X·ª≠ L√Ω';
                case 'cancelled': return 'ƒê√£ H·ªßy';
                default: return 'Kh√¥ng r√µ';
            }
        }

        // ‚≠êÔ∏è‚≠êÔ∏è H√ÄM RENDER (ƒê√É KH√îI PH·ª§C V√Ä C·∫¨P NH·∫¨T HI·ªÇN TH·ªä T√äN/SƒêT) ‚≠êÔ∏è‚≠êÔ∏è
        function renderOrderHistory(orders) {
            const container = document.getElementById('order-history-container');
            const noMessage = document.getElementById('no-history-message');

            if (!orders || orders.length === 0) {
                container.innerHTML = '';
                noMessage.style.display = 'block';
                return;
            }

            noMessage.style.display = 'none';
            orders.sort((a, b) => new Date(b.date) - new Date(a.date));

            const historyHTML = orders.map(order => {
                // T·∫°o HTML cho danh s√°ch s·∫£n ph·∫©m
                const productListHTML = order.products.map(p => `
                    <li class="product-item">
                        <span>${p.name} (x${p.quantity})</span>
                        <small>${formatter.format(p.price * p.quantity)}</small>
                    </li>
                `).join('');

                // üí• LOGIC HI·ªÇN TH·ªä T√äN/SƒêT (ƒê√É KH√îI PH·ª§C) üí•
                const deliveryDetailsHTML = `
                    <div style="font-size: 0.9em; margin-bottom: 10px; line-height: 1.6;">
                        <p style="margin: 0;">
                            Ng∆∞·ªùi nh·∫≠n: 
                            <span style="font-weight: bold; color: var(--primary);">
                                ${order.receiverName || '---'}
                            </span>
                        </p>
                        <p style="margin: 0; color: var(--muted);">
                            SƒêT: 
                            <span style="font-style: italic;">
                                ${order.receiverPhone || '---'}
                            </span>
                        </p>
                        <p style="margin: 0;">
                            ƒê·ªãa ch·ªâ: 
                            ${order.deliveryAddress || order.address || '---'}
                        </p>
                    </div>
                `;
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <span class="order-id">M√£ ƒêH: ${order.id}</span>
                                &nbsp;|&nbsp;
                                <small>Ng√†y ƒë·∫∑t: ${order.date}</small>
                            </div>
                            <span class="order-status ${getStatusClass(order.status)}">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                        
                        ${deliveryDetailsHTML} 
                        
                        <ul class="product-list">
                            ${productListHTML}
                        </ul>

                        <div class="order-total">
                            T·ªïng ti·ªÅn: <span style="color: var(--primary);">${formatter.format(order.total)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        // Kh·ªüi t·∫°o khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', () => {
            const userHistory = loadOrderHistory(); 
            renderOrderHistory(userHistory);
        });
    </script>
</body>
</html>